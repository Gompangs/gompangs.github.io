<!DOCTYPE html>





<html class="theme-next gemini use-motion" lang="ko">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.9.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    save_scroll: false,
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '복사',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    }
  };
</script>

  <meta name="description" content="개발덕후 삽질 끄적끄적..">
<meta name="keywords" content="곰팡이,Gompang,Development,Developer,JAVA">
<meta property="og:type" content="website">
<meta property="og:title" content="곰팡이 개발연구소">
<meta property="og:url" content="https://gompangs.github.io/index.html">
<meta property="og:site_name" content="곰팡이 개발연구소">
<meta property="og:description" content="개발덕후 삽질 끄적끄적..">
<meta property="og:locale" content="ko">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="곰팡이 개발연구소">
<meta name="twitter:description" content="개발덕후 삽질 끄적끄적..">
  <link rel="canonical" href="https://gompangs.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>곰팡이 개발연구소</title>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-68696489-4"></script>
  <script>
    var host = window.location.hostname;
    if (host !== "localhost" || !true) {
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-68696489-4');
    }
  </script>








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="ko">

  <div class="container sidebar-position-left">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">곰팡이 개발연구소</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">네임드 개발자가 되는 그날까지!</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>홈</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>태그<span class="badge">20</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>카테고리<span class="badge">4</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>아카이브<span class="badge">3</span></a>

  </li>
  </ul>

</nav>
</div>
    </header>

    

  <a href="https://github.com/gompangs" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="external nofollow noopener noreferrer" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content page-home">
            
  <section id="posts" class="posts-expand">
      

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://gompangs.github.io/2019/02/27/PasswordEncoder/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="곰팡이">
      <meta itemprop="description" content="개발덕후 삽질 끄적끄적..">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/11327843?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="곰팡이 개발연구소">
    </span>
      <header class="post-header">

        
          <h2 class="post-title" itemprop="name headline">
              
              <a href="/2019/02/27/PasswordEncoder/" class="post-title-link" itemprop="url">PasswordEncoder</a>
            
          </h2>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">작성일</span>

              
                
              

              <time title="Post created: 2019-02-27 02:41:34 / Updated at: 22:39:37" itemprop="dateCreated datePublished" datetime="2019-02-27T02:41:34+09:00">2019-02-27</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JAVA/" itemprop="url" rel="index"><span itemprop="name">JAVA</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JAVA/Security/" itemprop="url" rel="index"><span itemprop="name">Security</span></a></span>

                
                
              
            </span>
          

          
            
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/02/27/PasswordEncoder/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/27/PasswordEncoder/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p>Spring에서는 인증/권한인가 등의 처리가 필요할 때 사용하라고 만든 <code>Spring Security</code> 패키지가 존재한다.</p>
<p>그 중 유저가 입력하는 Password를 암호화해서 저장하는 방법에 대해서 알아보자</p>
<p>아, 그 전에 패스워드를 저장할 때 사용하는 알고리즘을 먼저 봐야 하는데 일단 패스워드는 무조건 <code>단방향</code> 암호화/해싱을 사용해야 한다. 한번 encode된 패스워드는 다시 복호화를 할 수 없도록 해야 하고(AES,RSA,DES… 등의 양방향 암호화를 사용하면 안된다는 뜻이다) 이를 비교하는 로직만 같은지 아닌지만 판단할 수 있게 만들어야 한다.</p>
<p>이를 지키지 않을 경우 최악은 DB에 저장된 유저의 패스워드가 다 복호화 되어 개인정보가 털리던.. 혹은 결제와 관련된 경우 직접적인 타격을 받게될 수도 있다.</p>
<p>혹여나, 지금이라도 패스워드를 AES 등으로 저장하여 사용하고 있다면 <strong>당장 해싱하는 방향으로 바꾸도록 하자</strong></p>
<p>그럼 유저가 패스워드를 잃어버렸을때 찾아주는 방법이 없지않냐! 할 수 있는데, 잘 생각해보면 우리 주위의 포털사이트나 웹사이트에서는 이미 “패스워드 변경 메일” 혹은 SMS등으로 인증을 해서 “새로운 비밀번호” 를 입력받도록 유도를 하고 있음을 알 수 있다.</p>
<p>한번 encode된 패스워드를 다시 복호화할 이유가 없다는건 이런 해결책이 있기 때문이기도 하고, 완벽한 보안은 없으면서도 그나마 강력한 보안성을 유지하기 위해서는 위와 같은 방법을 취하는게 옳은 방법이다.</p>
<h1 id="PasswordEncoder-Interface"><a href="#PasswordEncoder-Interface" class="headerlink" title="PasswordEncoder Interface"></a>PasswordEncoder Interface</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">encode</span><span class="params">(CharSequence var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence var1, String var2)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">upgradeEncoding</span><span class="params">(String encodedPassword)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>인터페이스를 먼저 보면, 간단하게 <code>encode()</code>와 <code>matches()</code>로 구성되어 있다.</p>
<p><code>encode</code> 는 실제로 패스워드를 암호화 할 때 사용하고</p>
<p><code>matches</code> 는 사용자에게 입력받은 패스워드를 비교하고자 할 때 사용한다</p>
<p>default 메서드로 구현된 <code>upgradeEncoding</code> 은 기본적으로 false를 리턴하나, Custom하게 구현할 경우 이를 기반으로 더 강력한 암호화를 실행할 것인지에 대한 로직처리를 해주면 될 것 같다.</p>
<blockquote>
<p>upgradeEncoding() : true if the encoded password should be encoded again for better security, else false.</p>
</blockquote>
<p><img src="/images/image-20190227211117809.png" alt="PasswordEncoder 구현체 종류"></p>
<p>Spring에서 기본적으로 제공되는 PasswordEncoder의 종류는 위와 같은데</p>
<p><code>BCryptPasswordEncoder</code>, <code>DelegatingPasswordEncoder</code>, <code>SCryptPasswordEncoder</code>, <code>Pbkdf2PasswordEncoder</code> 가 decrepated 되지 않은 PasswordEncoder 이므로 이들 클래스를 살펴보도록 하자.</p>
<h1 id="BCryptPasswordEncoder"><a href="#BCryptPasswordEncoder" class="headerlink" title="BCryptPasswordEncoder"></a>BCryptPasswordEncoder</h1><blockquote>
<p>Implementation of PasswordEncoder that uses the BCrypt strong hashing function. Clients can optionally supply a “strength” (a.k.a. log rounds in BCrypt) and a SecureRandom instance. The larger the strength parameter the more work will have to be done (exponentially) to hash the passwords. The default value is 10.</p>
</blockquote>
<p><a href="https://en.wikipedia.org/wiki/Bcrypt" rel="external nofollow noopener noreferrer" target="_blank">BCrypt</a> 라는 해시 함수를 사용한 구현체이다.  단순히 해시를 하는것 뿐만 아니라 <code>Salt</code> 를 넣는 작업까지 하므로, 입력값이 같음에도 불구하고 매번 다른 encoded된 값을 return 해주게 된다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(CharSequence rawPassword)</span> </span>&#123;</span><br><span class="line">    String salt;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.strength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.random != <span class="keyword">null</span>) &#123;</span><br><span class="line">            salt = BCrypt.gensalt(<span class="keyword">this</span>.strength, <span class="keyword">this</span>.random);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            salt = BCrypt.gensalt(<span class="keyword">this</span>.strength);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        salt = BCrypt.gensalt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// salt를 generate하고 rawPassword와 salt를 이용해 hashing을 한다</span></span><br><span class="line">    <span class="keyword">return</span> BCrypt.hashpw(rawPassword.toString(), salt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>그러므로 Bcrypt를 이용했을 경우에는 <code>matches</code> 함수를 잘 확인하고 사용하는게 좋다(입력값이 같아도 매번 출력물이 다르기 때문에 equal로 비교하려고 하면 패스워드가 계속 일치하지 않는 상황을 겪게될 수 있다)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String input = <span class="string">"hello world"</span>;</span><br><span class="line">String encoded = passwordEncoder.encode(input);</span><br><span class="line"></span><br><span class="line"><span class="comment">// true</span></span><br><span class="line">Assert.assertTrue(passwordEncoder.matches(input, encoded));</span><br><span class="line"></span><br><span class="line"><span class="comment">// false</span></span><br><span class="line">Assert.assertEquals(passwordEncoder.encode(input), passwordEncoder.encode(input));</span><br></pre></td></tr></table></figure>

<p>“hello world” 라는 문자열이 있을 때 이를 encode한 값을 encoded에 넣고 테스트를 해보면, matches 로 확인을 했을 경우에는 예상대로 <code>true</code> 가 리턴되지만, equals 로 확인을 해보면 값이 <code>false</code>로 리턴이 되는 것을 알 수 있다.</p>
<blockquote>
<p> 참고 : matches(rawPassword, encoded) 이다. rawPassword parameter에 암호화된 값을 넣지 말고, 사용자가 입력한 패스워드를 그대로 넣어주도록 하자</p>
</blockquote>
<h1 id="DelegatingPasswordEncoder"><a href="#DelegatingPasswordEncoder" class="headerlink" title="DelegatingPasswordEncoder"></a>DelegatingPasswordEncoder</h1><blockquote>
<p>A password encoder that delegates to another PasswordEncoder based upon a prefixed identifier.</p>
</blockquote>
<p>PasswordEncoder를 여러개 선언한 뒤, 상황에 맞게 골라쓸 수 있도록 지원하는 Encoder이다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String idForEncode = <span class="string">"bcrypt"</span>;</span><br><span class="line">Map encoders = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">encoders.put(idForEncode, <span class="keyword">new</span> BCryptPasswordEncoder());</span><br><span class="line">encoders.put(<span class="string">"noop"</span>, NoOpPasswordEncoder.getInstance());</span><br><span class="line">encoders.put(<span class="string">"pbkdf2"</span>, <span class="keyword">new</span> Pbkdf2PasswordEncoder());</span><br><span class="line">encoders.put(<span class="string">"scrypt"</span>, <span class="keyword">new</span> SCryptPasswordEncoder());</span><br><span class="line">encoders.put(<span class="string">"sha256"</span>, <span class="keyword">new</span> StandardPasswordEncoder());</span><br><span class="line">PasswordEncoder passwordEncoder = <span class="keyword">new</span> DelegatingPasswordEncoder(idForEncode, encoders);</span><br></pre></td></tr></table></figure>

<p>위와 같이 선언을 하게 되면 PasswordEncoder에 선언된 <code>bcrypt</code>, <code>noop</code>, <code>pbkdf2</code>, <code>scrypt</code>, <code>sha256</code> PasswordEncoder들이 들어가게 되고, 마지막에 선언했을 때 idForEncode를 bcrypt로 줬으니 최종으로 encoding이 되는 값은 bcrypt로 해싱이 된 패스워드가 return이 된다. 그리고 맨 앞에 prefix로 암호화를 한 방법이 붙는다</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;bcrypt&#125;$2a$10$UemKUf.cijGeJz6CJ/81auJKQVU0syWTJq2O.UGQXga9G.SCCKDR.</span><br></pre></td></tr></table></figure>

<p>위와 같이 맨 앞에 prefix로 저렇게 붙게 되어서, 어떤 암호화를 사용해서 encode를 했는지 구분하는 목적인것 같다.</p>
<p>여러가지의 패스워드 암호화를 뒀을 때 매번 DI를 해서 안써도 되니 그럴때 사용하면 유용할 것으로 추측..</p>
<p>matches를 호출하는건 인터페이스가 동일하다. prefix가 들어간 password를 앞에서 알아서 짤라서 맞는 encode방식으로 변환을 해준다.</p>
<h1 id="SCryptPasswordEncoder"><a href="#SCryptPasswordEncoder" class="headerlink" title="SCryptPasswordEncoder"></a>SCryptPasswordEncoder</h1><blockquote>
<p>Implementation of PasswordEncoder that uses the SCrypt hashing function. Clients can optionally supply a cpu cost parameter, a memory cost parameter and a parallelization parameter.</p>
</blockquote>
<p>좀 신기한놈인데, Scrypt 해시 함수를 사용하고, 추가적으로 cpu와 memory의 cost parameter를 넘길수 있게 되어있다.</p>
<p><code>Scrypt</code>는 실제로 <a href="https://en.wikipedia.org/wiki/Salsa20" rel="external nofollow noopener noreferrer" target="_blank">Salsa20</a> 라는 해싱방식을 사용한다고 한다.</p>
<p>그리고 왠지모르게 Javadoc에 이 패스워드 해싱방식을 추천하지 않는다고 쓰여있다(..?). 해당 글을 읽다보니 보안문제가 존재하지만 그래도 여전히 쓸만하다… 라는 느낌의 분석이 있었다(<a href="https://blog.ircmaxell.com/2014/03/why-i-dont-recommend-scrypt.html" rel="external nofollow noopener noreferrer" target="_blank">https://blog.ircmaxell.com/2014/03/why-i-dont-recommend-scrypt.html</a>)</p>
<h1 id="Pbkdf2PasswordEncoder"><a href="#Pbkdf2PasswordEncoder" class="headerlink" title="Pbkdf2PasswordEncoder"></a>Pbkdf2PasswordEncoder</h1><blockquote>
<p>A <code>PasswordEncoder</code> implementation that uses PBKDF2 with a configurable number of iterations and a random 8-byte random salt value</p>
</blockquote>
<p>이름이 매우 특이한데, <a href="https://en.wikipedia.org/wiki/PBKDF2" rel="external nofollow noopener noreferrer" target="_blank">PBKDF2</a> 라는 해싱을 사용하는 이놈의 이름은(<strong>Password-Based Key Derivation Function 2</strong>) 의 뜻을 가지고 있다. <a href="https://d2.naver.com/helloworld/318732" rel="external nofollow noopener noreferrer" target="_blank">네이버 D2 포스팅에도 한번 소개가 되었었다</a></p>
<p>이 encoder는 해싱+salt를 동시에 진행한다(Bcrypt와 동일)  다만 차이점은 아래와 같다</p>
<ul>
<li>Pbkdf2PasswordEncoder : salt가 8bytes 랜덤 값이다</li>
<li>BCryptPasswordEncoder : salt가 72bytes 랜덤값이다</li>
</ul>
<p>그렇기 때문에 bcrypt가 좀더 안전(하다고 말하기엔 좀 그렇지만, collision이 발생할 수학적 확률이 더 낮다고 볼 수 있다) 하기 때문에 Spring의 기본 PasswordEncoder는 bcrypt를 권장하는 것으로 보인다</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p><code>BCryptPasswordEncoder</code> 혹은 <code>Pbkdf2PasswordEncoder</code> 를 사용하자 인 것 같은데,</p>
<p>JMH Benchmark를 돌려본 결과 Pbkdf2의 성능이 상대적으로 낮게 측정이 되었다.</p>
<p>Pbkdf2가 좀더 심플하고, Random으로 받는 key bytes도 작아서 좋은 성능이 나올줄 알았는데 의외였다.</p>
<p><strong>Throughput : scrypt &gt; bcrypt &gt;&gt;&gt; pbkdf2</strong></p>
<p>평균 소모되는 operation 별 avg time또한 위와 같다.</p>
<p>단일 쓰레드에서 암호화 되는 <code>encode()</code> 만 테스트해본 결과이다.</p>
<p><strong>테스트 코드</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@State</span>(Scope.Benchmark)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EncodeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BCryptPasswordEncoder bCryptPasswordEncoder;</span><br><span class="line">    <span class="keyword">private</span> SCryptPasswordEncoder sCryptPasswordEncoder;</span><br><span class="line">    <span class="keyword">private</span> Pbkdf2PasswordEncoder pbkdf2PasswordEncoder;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String targetString = <span class="string">"HELLO WORLD ENCODE TEST"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Setup</span>(Level.Invocation)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bCryptPasswordEncoder= <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">        sCryptPasswordEncoder = <span class="keyword">new</span> SCryptPasswordEncoder();</span><br><span class="line">        pbkdf2PasswordEncoder = <span class="keyword">new</span> Pbkdf2PasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="meta">@Fork</span>(value = <span class="number">1</span>, warmups = <span class="number">1</span>)</span><br><span class="line">    <span class="meta">@BenchmarkMode</span>(Mode.All)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bcrypt</span><span class="params">()</span></span>&#123;</span><br><span class="line">        bCryptPasswordEncoder.encode(targetString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="meta">@Fork</span>(value = <span class="number">1</span>, warmups = <span class="number">1</span>)</span><br><span class="line">    <span class="meta">@BenchmarkMode</span>(Mode.All)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scrypt</span><span class="params">()</span></span>&#123;</span><br><span class="line">        sCryptPasswordEncoder.encode(targetString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="meta">@Fork</span>(value = <span class="number">1</span>, warmups = <span class="number">1</span>)</span><br><span class="line">    <span class="meta">@BenchmarkMode</span>(Mode.All)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pbkdf2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        pbkdf2PasswordEncoder.encode(targetString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, RunnerException </span>&#123;</span><br><span class="line">        org.openjdk.jmh.Main.main(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>테스트 결과</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># Run complete. Total time: 00:14:06</span><br><span class="line"></span><br><span class="line">Benchmark                           Mode  Cnt   Score    Error  Units</span><br><span class="line">EncodeTest.bcrypt                  thrpt   20  12.021 ±  0.038  ops/s</span><br><span class="line">EncodeTest.pbkdf2                  thrpt   20   2.279 ±  0.015  ops/s</span><br><span class="line">EncodeTest.scrypt                  thrpt   20  16.036 ±  0.143  ops/s</span><br><span class="line">EncodeTest.bcrypt                   avgt   20   0.083 ±  0.001   s/op</span><br><span class="line">EncodeTest.pbkdf2                   avgt   20   0.440 ±  0.002   s/op</span><br><span class="line">EncodeTest.scrypt                   avgt   20   0.066 ±  0.002   s/op</span><br><span class="line">EncodeTest.bcrypt                 sample  241   0.085 ±  0.001   s/op</span><br><span class="line">EncodeTest.bcrypt:bcrypt·p0.00    sample        0.082            s/op</span><br><span class="line">EncodeTest.bcrypt:bcrypt·p0.50    sample        0.083            s/op</span><br><span class="line">EncodeTest.bcrypt:bcrypt·p0.90    sample        0.087            s/op</span><br><span class="line">EncodeTest.bcrypt:bcrypt·p0.95    sample        0.091            s/op</span><br><span class="line">EncodeTest.bcrypt:bcrypt·p0.99    sample        0.117            s/op</span><br><span class="line">EncodeTest.bcrypt:bcrypt·p0.999   sample        0.168            s/op</span><br><span class="line">EncodeTest.bcrypt:bcrypt·p0.9999  sample        0.168            s/op</span><br><span class="line">EncodeTest.bcrypt:bcrypt·p1.00    sample        0.168            s/op</span><br><span class="line">EncodeTest.pbkdf2                 sample   60   0.439 ±  0.004   s/op</span><br><span class="line">EncodeTest.pbkdf2:pbkdf2·p0.00    sample        0.430            s/op</span><br><span class="line">EncodeTest.pbkdf2:pbkdf2·p0.50    sample        0.434            s/op</span><br><span class="line">EncodeTest.pbkdf2:pbkdf2·p0.90    sample        0.452            s/op</span><br><span class="line">EncodeTest.pbkdf2:pbkdf2·p0.95    sample        0.455            s/op</span><br><span class="line">EncodeTest.pbkdf2:pbkdf2·p0.99    sample        0.462            s/op</span><br><span class="line">EncodeTest.pbkdf2:pbkdf2·p0.999   sample        0.462            s/op</span><br><span class="line">EncodeTest.pbkdf2:pbkdf2·p0.9999  sample        0.462            s/op</span><br><span class="line">EncodeTest.pbkdf2:pbkdf2·p1.00    sample        0.462            s/op</span><br><span class="line">EncodeTest.scrypt                 sample  328   0.063 ±  0.001   s/op</span><br><span class="line">EncodeTest.scrypt:scrypt·p0.00    sample        0.059            s/op</span><br><span class="line">EncodeTest.scrypt:scrypt·p0.50    sample        0.061            s/op</span><br><span class="line">EncodeTest.scrypt:scrypt·p0.90    sample        0.071            s/op</span><br><span class="line">EncodeTest.scrypt:scrypt·p0.95    sample        0.073            s/op</span><br><span class="line">EncodeTest.scrypt:scrypt·p0.99    sample        0.081            s/op</span><br><span class="line">EncodeTest.scrypt:scrypt·p0.999   sample        0.090            s/op</span><br><span class="line">EncodeTest.scrypt:scrypt·p0.9999  sample        0.090            s/op</span><br><span class="line">EncodeTest.scrypt:scrypt·p1.00    sample        0.090            s/op</span><br><span class="line">EncodeTest.bcrypt                     ss        0.090            s/op</span><br><span class="line">EncodeTest.pbkdf2                     ss        0.824            s/op</span><br><span class="line">EncodeTest.scrypt                     ss        0.355            s/op</span><br></pre></td></tr></table></figure>


          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://gompangs.github.io/2019/02/17/dispatcherServlet/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="곰팡이">
      <meta itemprop="description" content="개발덕후 삽질 끄적끄적..">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/11327843?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="곰팡이 개발연구소">
    </span>
      <header class="post-header">

        
          <h2 class="post-title" itemprop="name headline">
              
              <a href="/2019/02/17/dispatcherServlet/" class="post-title-link" itemprop="url">Spring DispatcherServlet</a>
            
          </h2>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">작성일</span>

              
                
              

              <time title="Post created: 2019-02-17 23:30:11" itemprop="dateCreated datePublished" datetime="2019-02-17T23:30:11+09:00">2019-02-17</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Updated at: 2019-02-27 02:40:43" itemprop="dateModified" datetime="2019-02-27T02:40:43+09:00">2019-02-27</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JAVA/" itemprop="url" rel="index"><span itemprop="name">JAVA</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/JAVA/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a></span>

                
                
              
            </span>
          

          
            
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/02/17/dispatcherServlet/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/17/dispatcherServlet/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p><img src="/images/huiyV.jpg" alt="DispatcherServlet 구조"></p>
<p><a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/DispatcherServlet.html" rel="external nofollow noopener noreferrer" target="_blank">DispatcherServlet Javadoc 원문 설명</a></p>
<p>DispatcherServlet은 Spring의 모든 HTTP Call을 클라이언트(browser, http client …) 받아서 View 혹은 데이터를 내려주는 역할을 한다. 그리고 Handler를 등록해서 편리하게 url 매핑을 하거나, Exception Handling을 하는 것을 지원한다.</p>
<p>Spring에서 제공하는 servlet은 유연한 interface를 가지고 있고, 적절한 adapter class를 사용해서 이를 handling할 수 있으며, MVC Framework의 기본적인 기능을 제공한다.</p>
<p>MVC Pattern을 먼저 알아봐야 할 것 같은데,</p>
<p><img src="/images/1200px-MVC-Process.svg.png" alt="mvc pattern"></p>
<p>이 아키텍쳐가 기본적인 MVC Pattern이며, 아래의 구성요소를 가지고 있다</p>
<ul>
<li><p><code>Controller</code> : 유저가 사용하는 url로 구성이 되며, business logic을 처리해서 model에 값을 전달한다</p>
</li>
<li><p><code>Model</code> : Controller에서 처리된 데이터를 View로 내려주기 위해서 사용된다</p>
</li>
<li><p><code>View</code> : User에게 실제적으로 보여질 데이터를 처리한다</p>
</li>
</ul>
<p>매번 이런 패턴을 익히 들었을 법 한데, 실제로 Spring에서 이러한 패턴이 어떻게 활용되는지를 알아보자</p>
<ol>
<li>Controller</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/foo"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity <span class="title">foo</span><span class="params">(Bar bar)</span></span>&#123;</span><br><span class="line">        <span class="comment">// write logic of processing `foo`</span></span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().body(<span class="keyword">new</span> Bar());</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Controller는 간단하게 위와 같이 나타낼 수 있다. 유저가 요청한 url에 대한 mapping(<code>/foo</code>)에 대해서 요청을 처리 받고, 해당 logic을 처리한 다음에 값을 return해주는 역할을 담당한다.</p>
<p>위의 경우는 <code>@ResponseBody</code>  Annotation이 달려있기 때문에 View를 return하는게 아니라, Bar 라는 객체를 JSON으로 wrapping 해서 내려주는 케이스인데, Spring에서 View를 내려주려면 아래와 같이 해야 한다</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/foo/view"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"foo"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위와 같이 코드를 작성하게 되면 Spring 내부에서 <code>ViewResolver</code>가 동작해서 <code>foo</code> 라는 view를 찾아서 View를 유저에게 return을 해주게 된다. 공식적으로 지원하게 되는 View template는 JSP, Thymeleaf, FreeMarker, Groovy, Jade4j, Velocity, JMustache, Pebble 이 있다.</p>
<p>DispatcherServlet에서는 <code>@Controller</code> 어노테이션이 달린 클래스나, <code>@RequestMapping</code> 어노테이션이 달린 메서드가 기본적으로 auto-scan 되고 해당 url 혹은 beanName을 기반으로 등록이 된다. 이는 <code>ApplicationContext</code> 에 추가가 되며(<code>@Bean</code> 으로 등록이 된다는 말),  <code>RequestMappingHandlerMapping</code>이 초기화 될 때 ApplicationContext에 추가된 <code>@Controller</code> 에 해당하는 handler들을 모두 불러와서 해당 url에 맞게 DispatcherServlet에 등록이 되게 된다.</p>
<p>Exception resolution strategy가 존재하는데 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/mvc/method/annotation/ExceptionHandlerExceptionResolver.html" rel="external nofollow noopener noreferrer" target="_blank"><code>ExceptionHandlerExceptionResolver</code></a> <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/mvc/annotation/ResponseStatusExceptionResolver.html" rel="external nofollow noopener noreferrer" target="_blank"><code>ResponseStatusExceptionResolver</code></a>, <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/mvc/support/DefaultHandlerExceptionResolver.html" rel="external nofollow noopener noreferrer" target="_blank"><code>DefaultHandlerExceptionResolver</code></a>. 등을 사용해서 기본적인 Exception Handling을 한다. Whitelabel Error 라고 하면서 나오는 에러는 이 Resolver들에 의해서 Exception이 Catch되어 나타나게 되는 페이지이다.</p>
<p>그 밖에도 View를 찾기 위한  <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/ViewResolver.html" rel="external nofollow noopener noreferrer" target="_blank"><code>ViewResolver</code></a> , Multipart를 Handling하기 위한  <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/multipart/MultipartResolver.html" rel="external nofollow noopener noreferrer" target="_blank"><code>MultipartResolver</code></a> , 접근하는 사용자의 locale을 알기 위한  <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/servlet/LocaleResolver.html" rel="external nofollow noopener noreferrer" target="_blank"><code>LocaleResolver</code></a>. 그리고 페이지의 테마를 위한(?)  <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web//ThemeResolver.html" rel="external nofollow noopener noreferrer" target="_blank"><code>ThemeResolver</code></a> 정도가 기본으로 제공되는 Resolver 라고 보면 되겠다.</p>
<p>이런식으로 기본적인 MVC패턴을 이용해서 웹서비스를 하기 위한 기본적인 핸들러들이 등록이 되어 있으며, 필요에 따라 Customizing 하거나 Interface를 이용해서 새로 만들어서 추가를 하여 사용하기도 한다.</p>
<p>그럼 실제로 Request가 들어왔을 때 어떤 call stack으로 호출이 되는지 한번 알아보자</p>
<p>임의로 Controller에서 RuntimeException을 throw해봤다. (“/“ url 을 GET으로 호출)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">         ┌───────────────────────────┐</span><br><span class="line">         │  java.lang.Thread.run()   │</span><br><span class="line">         └───────────────────────────┘</span><br><span class="line">                       │</span><br><span class="line">                       ▼</span><br><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│java.util.concurrent.ThreadPoolExecutor.run()│</span><br><span class="line">└─────────────────────────────────────────────┘</span><br><span class="line">                       │</span><br><span class="line">                       ▼</span><br><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│  undertow.server.HttpServerExchange.run()   │</span><br><span class="line">└─────────────────────────────────────────────┘</span><br><span class="line">                       │</span><br><span class="line">                       ▼</span><br><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│      undertow.servlet.handleRequest()       │</span><br><span class="line">└─────────────────────────────────────────────┘</span><br><span class="line">                       │</span><br><span class="line">                       ▼</span><br><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│  AbstractSecurityContextAssociationHandler  │ <span class="comment">// SpringSecurity로 인해 호출됨</span></span><br><span class="line">└─────────────────────────────────────────────┘</span><br><span class="line">                       │</span><br><span class="line">                       ▼</span><br><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│       AuthenticationMechanismsHandler       │ <span class="comment">// SpringSecurity 인증flow </span></span><br><span class="line">└─────────────────────────────────────────────┘</span><br><span class="line">                       │</span><br><span class="line">                       ▼</span><br><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│          ServletDispatchingHandler          │ <span class="comment">// 드디어 이때 call</span></span><br><span class="line">└─────────────────────────────────────────────┘</span><br><span class="line">                       │</span><br><span class="line">                       ▼</span><br><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│               FilterChainImpl               │ <span class="comment">// Charset, Security filter 호출</span></span><br><span class="line">└─────────────────────────────────────────────┘</span><br><span class="line">                       │</span><br><span class="line">                       ▼</span><br><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│          ServletHandler.service()           │ </span><br><span class="line">└─────────────────────────────────────────────┘</span><br><span class="line">                       │</span><br><span class="line">                       ▼</span><br><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│            HttpServlet.service()            │ <span class="comment">// undertow -&gt; spring servlet</span></span><br><span class="line">└─────────────────────────────────────────────┘</span><br><span class="line">                       │</span><br><span class="line">                       ▼</span><br><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│          FrameworkServlet.doGet()           │ <span class="comment">// doGet()을 호출한다</span></span><br><span class="line">└─────────────────────────────────────────────┘</span><br><span class="line">                       │</span><br><span class="line">                       ▼</span><br><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│      FrameworkServlet.processRequest()      │ <span class="comment">// 최종</span></span><br><span class="line">└─────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p>아마 상황에 따라 호출되는 filter와 handler가 다르겠지만, 기본적으로는 위와 같이 호출이 되는걸 볼 수 있다 (spring boot tomcat -&gt; undertow로 교체하여 호출해본 결과)</p>
<p>원래 Spring boot에 오기 전에 Spring Framework를 사용했을 때는 web.xml을 수정해야 했던적이 있었다. web.xml에 url을 등록해서 해당 url로 들어왔을때의 Servlet Handler를 직접 지정해주는 방식을 사용했는데,  현재는 대부분 DispatcherServlet을 따로 설정하지 않고 기본적으로 모든 Request에 대해서 요청을 받는 DispatcherServlet을 1개 두고, 뒤에 Handler(<code>@Controller</code>) 를 둬서 처리하는 방식이 일반적이다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>example<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>example<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.form<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>예전에는 위와 같이 DispatcherServlet을 servlet으로 등록한 뒤, 해당 servlet을 직접 mapping(servlet-mapping) 해주는 작업을 해주곤 했었다..</p>
<p>번외로 Spring에서 기본적으로 지원하는 Servlet 엔진으로는 <code>Tomcat</code>, <code>Undertow</code>, <code>Jetty</code> 가 있다. (기본으로는 Embedded Tomcat이 사용된다) 인터페이스를 정의해두고 내부적으로 돌아가는 Setvlet Engine은 이를 구현함으로써 다양한 ServletEngine으로 교체하여 사용할 수 있다는 장점이 있다.</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://gompangs.github.io/2018/12/14/prometheus/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="곰팡이">
      <meta itemprop="description" content="개발덕후 삽질 끄적끄적..">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/11327843?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="곰팡이 개발연구소">
    </span>
      <header class="post-header">

        
          <h2 class="post-title" itemprop="name headline">
              
              <a href="/2018/12/14/prometheus/" class="post-title-link" itemprop="url">Prometheus 공부 및 Java client 연동</a>
            
          </h2>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">작성일</span>

              
                
              

              <time title="Post created: 2018-12-14 00:55:00" itemprop="dateCreated datePublished" datetime="2018-12-14T00:55:00+09:00">2018-12-14</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Updated at: 2019-02-18 02:43:25" itemprop="dateModified" datetime="2019-02-18T02:43:25+09:00">2019-02-18</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Monitoring/" itemprop="url" rel="index"><span itemprop="name">Monitoring</span></a></span>

                
                
              
            </span>
          

          
            
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/12/14/prometheus/#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/12/14/prometheus/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h2><p>Prometheus 는 오픈소스 모니터링 솔루션이다. (<a href="https://prometheus.io/" rel="external nofollow noopener noreferrer" target="_blank">https://prometheus.io/</a>)</p>
<p>크게 Prometheus 서버와, 메트릭 정보를 export할 export node로 구성이 되어 있다</p>
<p><img src="/images/prometheus/architecture2.png" alt="architecture"></p>
<p>구조가 좀 일반적인 모니터링 시스템과는 다르다는걸 느낄수가 있는데, 원래는 대부분의 솔루션이 메트릭을 수집할 때 메트릭이 발생한 서버에서 중앙 서버로 데이터를 전송해주는 구조로(push) 되어 있지만, 프로메테우스 같은 경우는 신기하게도 중앙서버(prometheus server)에서 메트릭을 polling 해서 가져가도록 구성이 되어 있다.</p>
<h3 id="장점"><a href="#장점" class="headerlink" title="장점"></a>장점</h3><p>이 솔루션을 쓰게 되면 얻을 수 있는 장점은, 아무래도 pull 방식의 구조를 채택함으로써 모든 메트릭에 대한 데이터를 중앙 서버로 보내지 않아도 된다는 점이다. 대부분의 모니터링 시스템 구조는 push방식으로 메트릭이 발생하면 해당 메트릭을 서버로 보내는 방식을 채택하고 있는데, 만약 부하가 높은 상황에서 그런 메트릭들을 수집하기 위해 전송하는 부분이 생긴다면? 부하와 더불어서 실제 어플리케이션에 문제를 유발할 수 있는 fail point가 생기는 것이다</p>
<p>Prometheus의 특성 상, 모든 데이터를 수집하지 않고 일정 주기(default 15s)로 발생하는 메트릭을 수집하여 추이나 모니터링을 <strong>어플리케이션에 무리 없이</strong> 하기 때문에 이러한 부분에서 매력적인 솔루션이라고 말할 수 있다.</p>
<p>또한 현재 Prometheus를 사용하고 있는 Vendor와 open-source들이 상당히 많다. 구조가 복잡하지 않고 간단하기 때문에 특정 솔루션에 대한 export를 하는 것이 어렵지 않다. 특히 Kubernetes와 Docker환경에서의 서비스의 메트릭을 수집하고 분석하는 대에 집중적으로 많이 사용이 되고 있다.</p>
<h3 id="단점"><a href="#단점" class="headerlink" title="단점"></a>단점</h3><p>Scale-out이 안된다(정확히 말하자면 억지로 되지만, 이것은 사실상 clustering이 아니라고 본다) 문서에 적혀있기를 Prometheus를 여러대에 구성해서 사용하려면 Prometheus에 Prometheus를 연결해서.. Hierarchy 구조를 만들어서 사용을 하면 된다 라고 하는데! 세상에 너무 지저분한 구조인 것 같다.</p>
<p>대부분 Clustering이라 함은.. Host를 여러대 두고 gossip을 통해 서로를 discovery 하고, 데이터를 sharding 및 replication을 해서 특정 노드가 죽어도 H/A(High Availability)를 보장해주는게 되어야 하는데 Prometheus 같은 경우는 그런 고가용성을 지원한다는 개념보다는 간단한 구조로 손쉽게 사용을 할 수 있다에 목적이 있는 것 같다.</p>
<p>또한, 위의 장점이 또 단점이 될 수 있는 부분인데 모든 메트릭을 전송하지 않기 때문에 사실상 “추이”를 보는데는 좋지만 APM(Application Performance Monitoring)과 같이 발생한 모든 로그를 추적하고 문제가 발생했을 때 이를 검색해서 어떤 일이 있었는지의 원인을 밝히고자 했을때는 적합하지 않은 솔루션이다.</p>
<h3 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h3><p>따라서 위의 장점만 가지고도 서비스 모니터링에 부합하는지를 잘 체크를 해서 도입을 해야할 필요성이 있다. 장/단점이 확실한 솔루션이다보니 push방식의 비슷한 솔루션들에 비해서는 모호한 부분은 없는 것 같다고 생각이 된다.</p>
<hr>
<h2 id="서버-내부-모듈"><a href="#서버-내부-모듈" class="headerlink" title="서버 내부 모듈"></a>서버 내부 모듈</h2><h3 id="Retrival"><a href="#Retrival" class="headerlink" title="Retrival"></a>Retrival</h3><p>메트릭을 수집할 대상 서버에 접근해서(HTTP) 메트릭을 가져오거나, 아니면 Pushgateway를 통해서 접근할 수 없는 곳에 있는 데이터(inner server, firewall 내부의 metric 등)를 가져오는 등의 역할을 하게 된다</p>
<p>Pushgateway는 쉽게말해 Proxy Forwarding을 해서 접근할 수 없는 곳에 데이터가 존재하는 경우 이때 사용할 수 있는 대안이라고 보면 된다. 사내망에 데이터가 있어서 외부에서 scrape를 하고싶어도 접근이 안되는 경우 말이다. 아무래도 메트릭 발생 서버 -&gt; 메트릭 집계 서버 가 아닌 메트릭 집계서버가 메트릭 발생 서버에 직접 접근을 해서 데이터를 가져가기 때문에 존재하는 개념인 듯 하다.</p>
<h3 id="TSDB-Time-series-Database"><a href="#TSDB-Time-series-Database" class="headerlink" title="TSDB(Time-series Database)"></a>TSDB(Time-series Database)</h3><p>이렇게 가져온 데이터를 저장하고, 시간의 흐름에 따라 조회를 할 수 있어야 하므로 시-계열 데이터(time-series) 를 저장할 수 있는 저장소가 prometheus 내부에 구현이 되어 있다.</p>
<p>데이터를 저장하는 방법은 Local Storage, Remote Storage를 이용하는 방법 두 가지가 존재한다. 대부분 Local Storage를 쓰는걸로 default로 사용하겠지만 필요에 따라서 원격지에 있는 서버에 데이터를 저장해서 사용을 한다고 한다</p>
<p><img src="https://image.slidesharecdn.com/copyofprometheusstorage1-160127133731/95/prometheus-storage-9-638.jpg?cb=1453901940" alt="prometheus architecture"></p>
<p>내부 저장소는 Google에서 만든 <a href="https://github.com/google/leveldb" rel="external nofollow noopener noreferrer" target="_blank">Level DB</a>를 사용하는걸로 보인다 light-weight의 Key-value 저장소이며 전반적으로 뛰어난 성능을 보이기에 여러군데서 차용해서 쓰는것 같다.(프로메테우스도)</p>
<p><img src="https://image.slidesharecdn.com/copyofprometheusstorage1-160127133731/95/prometheus-storage-7-638.jpg?cb=1453901940" alt="prometheus metric schema"></p>
<p>프로메테우스의 메트릭은 위와 같이 수집이 되는데 </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">메트릭명&#123;필드1=값, 필드2=값&#125; 샘플링데이터</span><br></pre></td></tr></table></figure>

<p>실제로 timestamp값은 프로메테우스 서버 내부에서 저장될 때 같이 넣게 되고 export하는 부분에서는 메트릭명-샘플링데이터와 같은 형태로 보여지게 된다.</p>
<p><img src="https://3.bp.blogspot.com/-eduU9hfXlCY/WhJT2x6oFqI/AAAAAAAAff8/sUiEeCflN-E9oY5Vn98ypNgx-fYlxv4IgCLcBGAs/s1600/Micrometer-Boot2.png" alt="spring boot micrometer metric(exported)"></p>
<p>이게 Spring boot에 Prometheus export 라이브러리를 붙인 모습인데, 보다시피 많은수의 메트릭이 발생을 하게 되고, 이를 text/html 방식으로 특정 url(대부분 /metrics)로 export를 해두게 되면, prometheus 서버가 이를 긁어가서 데이터를 저장하는 구조이다.</p>
<h3 id="HTTP-Server"><a href="#HTTP-Server" class="headerlink" title="HTTP Server"></a>HTTP Server</h3><p>prometheus에 저장된 데이터를 조회하기 위해서는 내부적으로 HTTP 서버가 필요하다. 따라서 prometheus는 데이터를 가져가기 위한 프로토콜로 HTTP REST API를 제공하고, 직접 API를 통해 데이터를 가져가던지, Web UI 대시보드에서 데이터를 조회한다던지, Grafana를 통해 더욱 자세하고 깔끔한 데이터 시각화를 할 수 있다</p>
<h3 id="Web-UI"><a href="#Web-UI" class="headerlink" title="Web UI"></a>Web UI</h3><p>원래는 시각화를 위한 툴을 붙여서 보는게 더 좋지만, 그렇게 하지 않아도 기본적으로 제공하는 Dashboard가 있다.</p>
<p><img src="https://www.callicoder.com/assets/images/post/large/spring-boot-actuator-metrics-dashboard-prometheus-graph.jpg" alt="prometheus dashboard"></p>
<p>위와 같이 Bootstrap으로 작성된듯한 투박한 대시보드가 제공이 되고, 간단하게 보고싶은 메트릭에 대한 그래프를 볼 수 있는 정도이다. 한 대시보드에 여러개의 메트릭의 추이를 보고싶다던지, 다른 그래프 형식으로 보고싶다던지 하는 것들은 지원이 되지 않으며 이는 Grafana를 통해 시각화가 가능하니 그쪽을 보도록 하자.</p>
<h3 id="Alert-Manager"><a href="#Alert-Manager" class="headerlink" title="Alert Manager"></a>Alert Manager</h3><p>모니터링 시스템이니, 문제가 발생하면 이를 알람으로 보내주는 역할도 있어야한다. Alertmanager는 Prometheus에서 문제가 발생했다고 생각되는 시점에 slack, hipchat 등을 통해 알람을 보내준다.</p>
<p>알람을 거는 기준은 Rule을 작성해서 load시키는 방식으로 동작하는데</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expr: job:request_latency_seconds:mean5m&#123;job=&quot;myjob&quot;&#125; &gt; 0.5</span><br></pre></td></tr></table></figure>

<p>와 같이 expression을 작성하는 것으로 알람을 전송할 수 있다. 특정 메트릭의 값이 어느정도 선(threshold)을 넘는다거나, 낮아진다거나 하는 메트릭을 보고 판단을 할 수 있다.</p>
<p>다만, 이 또한 Grafana를 사용하게 된다면 Grafana에서도 동일하게 알람매니저를 제공을 하고 있는데, 아무래도 Grafana쪽이 사용하기 더 쉽고 직관적이기 때문에 이걸 직접 사용할까는 싶지만, 그래도 expression을 이용해서 더 복잡한 조건을 걸어서 알람을 노티해주는 방식이 있다는건 좋다.</p>
<p><img src="https://pracucci.com/assets/2017-04-01-kubecon-2017-alerts-24e7dcdc29996e951730bb67937e4c2a685b554ffd88f502a8b6e650cd42025f.png" alt=""></p>
<h2 id="Prometheus-Server-설치"><a href="#Prometheus-Server-설치" class="headerlink" title="Prometheus Server 설치"></a>Prometheus Server 설치</h2><h3 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h3><p>일단 client를 만져보기 전에 prometheus 서버를 설치를 해보도록 하자.</p>
<p>다운로드는 <a href="https://prometheus.io/download/#prometheus" rel="external nofollow noopener noreferrer" target="_blank">https://prometheus.io/download/#prometheus</a> 에서 할 수 있다</p>
<p>prometheus 서버 말고도 각종 exporter가 있다(node js, alertmanager 등).. 여기서는 prometheus server만 받아서 맞는 운영체제 버전으로 받자</p>
<p>본인은 odroid의 armv7을 사용하고 있어서 해당 바이너리로 받게 되었고,</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.5.0/prometheus-2.5.0.linux-armv7.tar.gz</span><br><span class="line">tar xvfz prometheus-2.5.0.linux-armv7.tar.gz</span><br><span class="line">cd prometheus-2.5.0.linux-armv7</span><br><span class="line">./prometheus</span><br></pre></td></tr></table></figure>

<p>로 바로 실행을 할 수 있다. 다만 지금은 서버가 뜨긴 하지만 아무런 메트릭을 수집하지 않고있다. 이는 prometheus.yml에서 scape를 할 target을 지정하지 않았기 때문이다. 지금은 단순히 9090포트로 접근을 해보면 Prometheus의 대시보드를 볼 수 있을것이다</p>
<p><img src="https://www.joyfulbikeshedding.com/images/2018/prometheus-42e58d9a.png" alt="prometheus 대시보드 메트릭 확인"></p>
<p>대시보드에서 무언가를 보기 위해서는 일단 prometheus.yml 의 내용을 보도록 하자</p>
<h3 id="prometheus-yml"><a href="#prometheus-yml" class="headerlink" title="prometheus.yml"></a>prometheus.yml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my global config</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span>     <span class="number">15</span><span class="string">s</span> <span class="comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span></span><br><span class="line"><span class="attr">  evaluation_interval:</span> <span class="number">15</span><span class="string">s</span> <span class="comment"># Evaluate rules every 15 seconds. The default is every 1 minute.</span></span><br><span class="line">  <span class="comment"># scrape_timeout is set to the global default (10s).</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Alertmanager configuration</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line"><span class="attr">  alertmanagers:</span></span><br><span class="line"><span class="attr">  - static_configs:</span></span><br><span class="line"><span class="attr">    - targets:</span></span><br><span class="line">      <span class="comment"># - alertmanager:9093</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="comment"># - "first_rules.yml"</span></span><br><span class="line">  <span class="comment"># - "second_rules.yml"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="comment"># Here it's Prometheus itself.</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'prometheus'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># metrics_path defaults to '/metrics'</span></span><br><span class="line">    <span class="comment"># scheme defaults to 'http'.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">    - targets:</span> <span class="string">['localhost:9090']</span></span><br></pre></td></tr></table></figure>

<p>설정이 다른 모니터링 서비스들에 비해서는 매우 간단한 편이다. (모든 설정이 간편한건 아니다. default로 설정 되어있는 config가 간단해서 그렇지, 실제로 모든 config의 field를 보면 상당히 양이 많다. 자세한건 <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/" rel="external nofollow noopener noreferrer" target="_blank">https://prometheus.io/docs/prometheus/latest/configuration/configuration/</a>) </p>
<h4 id="config-설명"><a href="#config-설명" class="headerlink" title="config 설명"></a>config 설명</h4><ul>
<li>global.scrape_interval : 몇 초 단위로 메트릭을 수집할 지를 결정(15초로 기본으로 되어 있는데, 이를 수정하여 1초단위로 수집을 할 지.. 10초 단위로 수집할지.. 1분 단위로 수집할지를 결정할 수 있다)</li>
<li>global.evaluation_interval : 이건 alerting rule을 어느 주기로 evaluate를 할 것인지에 대한 설정이다. evaluate를 하게되면 그 결과를 바탕으로 (inactive, pending, firing) 의 세 state로 구분이 되고 그 상태를 기반으로 alertmanager에서 알람을 발송할 지 안할지를 결정할 수 있다<ul>
<li>alertmanager의 rule은 위에서 언급한대로 expression을 사용해서 설정을 할 수 있다</li>
</ul>
</li>
<li>alerting : alertmanager의 target port를 지정할 수 있다. prometheus를 실행하면 alertmanager가 자동으로 같이 뜨는게 아니라, alertmanager를 download해서 같이 구동을 시켜줘야 한다</li>
<li>rule_files : expression으로 구성된 rule file의 path를 지정해준다. 복수개의 파일을 지정할 수 있다</li>
<li>scrape_config : 이부분이 중요하다.<ul>
<li>job_name : 메트릭을 수집해서 구분을 할 네이밍을 지정</li>
<li>static_configs.targets : 실제 메트릭을 수집할 서버의 주소를 지정한다. 리스트로 구성이 되어 있으며 여러개의 호스트를 지정할 수 있다</li>
</ul>
</li>
</ul>
<p>간단하게 static_configs의 target만 고쳐서 prometheus를 띄워보도록 하자</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- targets:</span> <span class="string">['192.168.0.3:9090']</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/prometheus/prom1.png" alt="prometheus 실행">    </p>
<p>서버가 잘 실행이 되면 위와 같이 <strong><em>Server is ready to receive web requests.</em></strong> 라는 메세지가 나오게 된다.</p>
<p>이제 메트릭을 수집하기 위해 sample client를 만들어봐야하는데, 간단하게 spring boot로 구성을 해서 띄워보도록 하겠다. 샘플 프로젝트는 github에 올려놨으니 보고 참고를 하면 좋을 것 같다.</p>
<blockquote>
<p>spring boot sample project : <a href="https://github.com/Gompangs/prometheus-client-sample" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/Gompangs/prometheus-client-sample</a></p>
</blockquote>
<h2 id="Spring-Boot-Sample-Client-Java"><a href="#Spring-Boot-Sample-Client-Java" class="headerlink" title="Spring Boot Sample Client(Java)"></a>Spring Boot Sample Client(Java)</h2><h3 id="프로젝트-생성"><a href="#프로젝트-생성" class="headerlink" title="프로젝트 생성"></a>프로젝트 생성</h3><p>pom.xml에 아래의 dependency를 추가하게 되면 prometheus client가 추가가 되게 된다.</p>
<p>사실 이런 방식 말고 spring boot용 prometheus client가 존재를 해서 그걸 dependency로 가져오게 되면 훨씬 간단하게 바로 사용을 할 수 있는데, 어떻게 돌아가는지를 직접 보면서 metric을 export를 해보기 위해서 client 모듈을 직접 가져와서 사용해보도록 하자.</p>
<p>참고. Spring boot용 client는 actuator를 활용해서 구현이 되어 있다(<a href="https://www.callicoder.com/spring-boot-actuator-metrics-monitoring-dashboard-prometheus-grafana/" rel="external nofollow noopener noreferrer" target="_blank">https://www.callicoder.com/spring-boot-actuator-metrics-monitoring-dashboard-prometheus-grafana/</a>) 를 참고하면 연동방법에 대해 나와 있다.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- The client --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Hotspot JVM metrics--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient_hotspot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Exposition HTTPServer--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient_httpserver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>dependency를 추가하고, spring boot dependency를 추가하고나서 Java bean config쪽을 구성해보자</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrometheusConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultExports.initialize(); <span class="comment">// Export JVM Metrics into http endpoint</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HTTPServer <span class="title">prometheusServer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"promethues server has started"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HTTPServer(<span class="number">9090</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>보면 그냥 configuration 클래스가 로딩될 때, DefaultExports로 initialize를 해주고, prometheus 서버를 띄워주는 역할만 하고 있다.</p>
<p>이렇게 구성해서 띄워보면, 실제로 9090포트로 prometheus metric exporter가 구동이 되게 된다. 접근해보면 아래와 같은 페이지가 나오게 된다</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># HELP jvm_memory_bytes_used Used bytes of a given JVM memory area.</span><br><span class="line"># TYPE jvm_memory_bytes_used gauge</span><br><span class="line">jvm_memory_bytes_used&#123;area="heap",&#125; 8.0815512E7</span><br><span class="line">jvm_memory_bytes_used&#123;area="nonheap",&#125; 4.3263472E7</span><br><span class="line"># HELP jvm_memory_bytes_committed Committed (bytes) of a given JVM memory area.</span><br><span class="line"># TYPE jvm_memory_bytes_committed gauge</span><br><span class="line">jvm_memory_bytes_committed&#123;area="heap",&#125; 1.6777216E8</span><br><span class="line">jvm_memory_bytes_committed&#123;area="nonheap",&#125; 4.5481984E7</span><br><span class="line"># HELP jvm_memory_bytes_max Max (bytes) of a given JVM memory area.</span><br><span class="line"># TYPE jvm_memory_bytes_max gauge</span><br><span class="line">jvm_memory_bytes_max&#123;area="heap",&#125; 1.908932608E9</span><br><span class="line">jvm_memory_bytes_max&#123;area="nonheap",&#125; -1.0</span><br><span class="line"># HELP jvm_memory_bytes_init Initial bytes of a given JVM memory area.</span><br><span class="line"># TYPE jvm_memory_bytes_init gauge</span><br><span class="line">jvm_memory_bytes_init&#123;area="heap",&#125; 1.34217728E8</span><br><span class="line">jvm_memory_bytes_init&#123;area="nonheap",&#125; 2555904.0</span><br><span class="line"># HELP jvm_memory_pool_bytes_used Used bytes of a given JVM memory pool.</span><br><span class="line"># TYPE jvm_memory_pool_bytes_used gauge</span><br><span class="line">jvm_memory_pool_bytes_used&#123;pool="Code Cache",&#125; 7142976.0</span><br><span class="line">jvm_memory_pool_bytes_used&#123;pool="Metaspace",&#125; 3.1820632E7</span><br><span class="line">jvm_memory_pool_bytes_used&#123;pool="Compressed Class Space",&#125; 4299864.0</span><br><span class="line">jvm_memory_pool_bytes_used&#123;pool="PS Eden Space",&#125; 5.7521336E7</span><br><span class="line">jvm_memory_pool_bytes_used&#123;pool="PS Survivor Space",&#125; 8909040.0</span><br><span class="line">jvm_memory_pool_bytes_used&#123;pool="PS Old Gen",&#125; 1.4385136E7</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>값을 보게 되면 JVM에 사용되는 메트릭에 대한 정보가 export되었다는 걸 알 수 있다</p>
<p>실제 DefaultExports.initialize(); 가 어떻게 구현되었는지를 보면 어떤 정보가 export되는지 볼 수 있는데</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!initialized) &#123;</span><br><span class="line">        (<span class="keyword">new</span> StandardExports()).register();</span><br><span class="line">        (<span class="keyword">new</span> MemoryPoolsExports()).register();</span><br><span class="line">        (<span class="keyword">new</span> MemoryAllocationExports()).register();</span><br><span class="line">        (<span class="keyword">new</span> BufferPoolsExports()).register();</span><br><span class="line">        (<span class="keyword">new</span> GarbageCollectorExports()).register();</span><br><span class="line">        (<span class="keyword">new</span> ThreadExports()).register();</span><br><span class="line">        (<span class="keyword">new</span> ClassLoadingExports()).register();</span><br><span class="line">        (<span class="keyword">new</span> VersionInfoExports()).register();</span><br><span class="line">        initialized = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>메모리와 쓰레드, 그리고 GC등에 대한 정보를 가져와서 등록하는 부분이 있는걸 볼 수 있다.</p>
<p>이제 JVM에 관련된 메트릭 말고 실제 원하는 메트릭을 export를 해봐야 하는데, 그러기 위해서는 export를 할 수 있는 metric의 타입이 어떤것들이 있는지부터 알아보고 가야한다</p>
<p>상세 설명 및 정보는 공식 홈페이지에(<a href="https://prometheus.io/docs/concepts/metric_types/" rel="external nofollow noopener noreferrer" target="_blank">https://prometheus.io/docs/concepts/metric_types/</a>) 있다.</p>
<p>크게 4가지의 메트릭 타입이 존재한다.</p>
<h4 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h4><p>값을 나타내는 메트릭인데, “증가”만 할 수 있는 메트릭이라고 보면 된다. 카운터는 값을 증감시키거나, 0으로 초기화해서 다시 시작하거나 하는 기능만 지원을 한다. 그렇기 때문에 좀 제한적인 부분에만 사용을 할 수 있을 것 같은데, 아래와 같은 경우에 사용이 가능하지 않을까 싶다.</p>
<ul>
<li>http total send bytes</li>
<li>http total request</li>
<li>running time</li>
</ul>
<h4 id="Gauge"><a href="#Gauge" class="headerlink" title="Gauge"></a>Gauge</h4><p>게이지는 카운터와 개념은 같지만, 값이 “증감”하거나 “감소”할 수 있다. 따라서 하나의 값을 나타내는 경우에는 대부분 게이지를 사용을 해서 구현을 하면 될 것 같다.</p>
<ul>
<li>temperature</li>
<li>current cpu usage</li>
<li>current thread count</li>
<li>… </li>
</ul>
<h4 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a>Histogram</h4><p>특정 기간동안 측정된 값을 표현할 때 사용한다. 모든 메트릭 데이터의 합계를 제공하고 quantile을 계산(0.95, 0.99 …) 할 수 있도록 지원한다. </p>
<ul>
<li>TPS(Transaction per second)</li>
<li>특정 기간동안의 집계나 API 콜 수 등을 보고싶을때</li>
</ul>
<h4 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h4><p>히스토그램과 비슷하지만, φ-quantiles을 지원한다는 점이 차이점이고 슬라이딩 시간단위의 윈도우를 계산할때 사용한다(이건 사실 무슨 소리인지 잘 모르겠다 언제 써야할지..)</p>
<h3 id="Gauge-사용해보기"><a href="#Gauge-사용해보기" class="headerlink" title="Gauge 사용해보기"></a>Gauge 사용해보기</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Gauge sampleGauge;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sampleGauge = Gauge.build(<span class="string">"sample"</span>, <span class="string">"sample metrics"</span>).register();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sample</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sampleGauge.inc();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"sample"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Gauge를 사용해봤는데, 위와 같이 사용을 하면 된다. Gauge의 build를 통해서 메트릭의 이름을 지정해주고 이를 register(); 해주면 해당 메트릭이 등록이 되게 된다.</p>
<p>그리고 sample을 호출할때마다 sampleGauge의 값이 inc가 된다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># HELP sample sample metrics</span><br><span class="line"># TYPE sample gauge</span><br><span class="line">sample 0.0</span><br></pre></td></tr></table></figure>

<p>처음에 spring boot를 띄우게 되면 9090포트로 위와같은 메트릭이 export가 되게 되는데, localhost:8080으로 sample을 호출을 하게 되면 위의 sample값이 1.0 , 2.0 … 와 같이 변하게 된다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Counter.build(<span class="string">"someCounter"</span>, <span class="string">"Some counter"</span>).register();</span><br></pre></td></tr></table></figure>

<p>Counter의 경우에도 위와같이 build -&gt; register를 하게 되면 metric에 등록이 되게 된다.</p>
<p>간단한 gauge랑 counter의 경우는 위와같이 쓰면 되지만 실제로 많이 사용하게 될 메트릭들은 대부분 histogram과 summary일텐데 이건 공부가 좀더 필요해보인다. spring boot prometheus client(micrometer)를 기본으로 export하면 대부분 summary를 많이 사용하는 걸로 보인다(histogram은 안쓰고 summary만 씀)</p>
<h3 id="Spring-boot-exporter"><a href="#Spring-boot-exporter" class="headerlink" title="Spring boot exporter"></a>Spring boot exporter</h3><p>custom하게 metric을 export하는건 위에서 아주 살짝 맛만 봤는데, 실제로 잘 구현된 metric은 어떻게 구성되는지를 한번 알아보자. spring boot의 경우 actuator를 사용하면 별도의 설정없이 tomcat, jvm, spring에 관련된 정보를 export할 수 있다. (<a href="https://dzone.com/articles/monitoring-using-spring-boot-2-prometheus-and-graf" rel="external nofollow noopener noreferrer" target="_blank">https://dzone.com/articles/monitoring-using-spring-boot-2-prometheus-and-graf</a>)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Spring boot actuator to expose metrics endpoint --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Micormeter core dependecy  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.micrometer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>micrometer-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Micrometer Prometheus registry  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.micrometer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>pom.xml에 위의 dependency를 import하고</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#Metrics related configurations</span></span><br><span class="line"><span class="string">management.endpoint.metrics.enabled=true</span></span><br><span class="line"><span class="string">management.endpoints.web.exposure.include=*</span></span><br><span class="line"><span class="string">management.endpoint.prometheus.enabled=true</span></span><br><span class="line"><span class="string">management.metrics.export.prometheus.enabled=true</span></span><br></pre></td></tr></table></figure>

<p>application.properties에 위와 같은 config를 넣어주게 되면 localhost:8080/actuator/prometheus로 metric이 export되게 된다</p>
<p>그리고 grafana에서 보여지게 될 tag를 붙여줘야 한다</p>
<p>@Configuration 클래스를 하나 만들어서 아래의 bean을 등록해주자</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrometheusCustomConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">MeterRegistryCustomizer&lt;MeterRegistry&gt; <span class="title">metricsCommonTags</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> registry -&gt; registry.config().commonTags(<span class="string">"application"</span>, <span class="string">"PROMETHEUS-SAMPLE-SERVER"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이렇게 해야 grafana에서 여러개의 scrape target이 있을때 tag를 가지고 구분을 할 수 있게 된다.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># HELP http_server_requests_seconds  </span><br><span class="line"># TYPE http_server_requests_seconds summary</span><br><span class="line">http_server_requests_seconds_count&#123;exception="None",method="GET",outcome="SUCCESS",status="200",uri="/actuator/prometheus",&#125; 1.0</span><br><span class="line">http_server_requests_seconds_sum&#123;exception="None",method="GET",outcome="SUCCESS",status="200",uri="/actuator/prometheus",&#125; 0.083506614</span><br><span class="line">http_server_requests_seconds_count&#123;exception="None",method="GET",outcome="SUCCESS",status="200",uri="/",&#125; 5.0</span><br><span class="line">http_server_requests_seconds_sum&#123;exception="None",method="GET",outcome="SUCCESS",status="200",uri="/",&#125; 0.094335788</span><br><span class="line">http_server_requests_seconds_count&#123;exception="None",method="GET",outcome="SUCCESS",status="200",uri="/**/favicon.ico",&#125; 4.0</span><br><span class="line">http_server_requests_seconds_sum&#123;exception="None",method="GET",outcome="SUCCESS",status="200",uri="/**/favicon.ico",&#125; 0.042993164</span><br><span class="line">http_server_requests_seconds_count&#123;exception="None",method="GET",outcome="SUCCESS",status="200",uri="/actuator",&#125; 1.0</span><br><span class="line">http_server_requests_seconds_sum&#123;exception="None",method="GET",outcome="SUCCESS",status="200",uri="/actuator",&#125; 0.073100047</span><br></pre></td></tr></table></figure>

<p>한 예로, http server의 RPS(Request per second)의 경우에 위와 같이 export를 해주는데, 보면 uri와 httpStatus, method 등을 나타내준다. 이를 시간별로 sum, count값을 보여주므로 그래프에 표현하게 되면 시간대별 HTTP 호출 그래프를 그릴 수 있다(Grafana)</p>
<h2 id="Prometheus-Server에-메트릭-수집하기"><a href="#Prometheus-Server에-메트릭-수집하기" class="headerlink" title="Prometheus Server에 메트릭 수집하기"></a>Prometheus Server에 메트릭 수집하기</h2><p>위 서버를 구동시켜두고(8080포트) prometheus에서 이 서버로의 metric을 수집해보도록 config파일을 바꿔보자(공유기 내부 네트워크라서 192.168.0.x 로 설정을 했지만, 실 서비스에서는 prometheus서버가 metric export를 하는 서버에 http(80)으로 접근이 가능해야 수집이 가능하다)</p>
<p>그리고 spring boot metric exporter를 사용하게 되면 scrape path가 달라져야 하는데, 기본으로는 host 주소를 적은 뒤 “/metrics”에서 긁어오지만 spring boot의 경우는 /actuator/prometheus에서 가져오기 때문에 아래와 같이 설정을 바꿔줘야 한다</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my global config</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line"><span class="attr">  scrape_interval:</span>     <span class="number">1</span><span class="string">s</span> <span class="comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span></span><br><span class="line"><span class="attr">  evaluation_interval:</span> <span class="number">1</span><span class="string">s</span> <span class="comment"># Evaluate rules every 15 seconds. The default is every 1 minute.</span></span><br><span class="line">  <span class="comment"># scrape_timeout is set to the global default (10s).</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Alertmanager configuration</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line"><span class="attr">  alertmanagers:</span></span><br><span class="line"><span class="attr">  - static_configs:</span></span><br><span class="line"><span class="attr">    - targets:</span></span><br><span class="line">      <span class="comment"># - alertmanager:9093</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="comment"># - "first_rules.yml"</span></span><br><span class="line">  <span class="comment"># - "second_rules.yml"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="comment"># Here it's Prometheus itself.</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line"><span class="attr">  - job_name:</span> <span class="string">'prometeus-sample-server'</span></span><br><span class="line">    <span class="comment"># metrics_path defaults to '/metrics'</span></span><br><span class="line">    <span class="comment"># scheme defaults to 'http'.</span></span><br><span class="line"><span class="attr">    metrics_path:</span> <span class="string">'/actuator/prometheus'</span></span><br><span class="line"><span class="attr">    static_configs:</span></span><br><span class="line"><span class="attr">            - targets:</span> <span class="string">['192.168.0.3:8080']</span></span><br></pre></td></tr></table></figure>

<p>보면 scrape_configs에 metrics_path가 설정되었는데, 기본으로는 metrics지만 이를 actuator/prometheus로 변경해주는 부분이다. 이렇게 설정하고 잘 실행이 되면 prometheus dashboard를 가서 확인해보자</p>
<p><img src="/images/prometheus/prom2.png" alt="prometheus 대시보드 - 메트릭 조회">    </p>
<p>아무거나(http_server_requests_second를 골랐다) 선택해서 execute를 한 뒤 그래프를 확인해보면 위와같이 잘 나오는걸 알 수 있다.</p>
<h2 id="Grafana에서-그래프-연동하기"><a href="#Grafana에서-그래프-연동하기" class="headerlink" title="Grafana에서 그래프 연동하기"></a>Grafana에서 그래프 연동하기</h2><p>사실 이부분은 손이 매우많이 가기도 하고 어려운 부분이지만, 다행히도 이를 간편화해서 대시보드를 만들어놓으신분들이 있으셔서 grafana 공식 홈페이지에서 이를 받아서 사용할 수 있다</p>
<p><a href="http://docs.grafana.org/installation/debian/" rel="external nofollow noopener noreferrer" target="_blank">http://docs.grafana.org/installation/debian/</a> 에서 다운로드를 받아서 서버에 설치하자</p>
<p><img src="https://grafana.com/api/dashboards/4701/images/5594/image" alt="Grafana JVM Micrometer 대시보드"></p>
<p>이런 훌륭한 대시보드를 미리 만들어뒀으니 갖다 써보자.</p>
<p>써보려고 하는 대시보드는JVM(Micrometer) 이다(<a href="https://grafana.com/dashboards/4701" rel="external nofollow noopener noreferrer" target="_blank">https://grafana.com/dashboards/4701</a>)</p>
<p>Datasource 등록하기 : <a href="http://docs.grafana.org/guides/getting_started/" rel="external nofollow noopener noreferrer" target="_blank">http://docs.grafana.org/guides/getting_started/</a></p>
<p>Dashboard import하기 :  <a href="http://docs.grafana.org/reference/export_import/" rel="external nofollow noopener noreferrer" target="_blank">http://docs.grafana.org/reference/export_import/</a></p>
<p>성공적으로 Datasource와 Dashboard를 import했다면 대시보드에 접근해보자. 아래와 같은 화면이 나올 것이다.</p>
<p><img src="/images/prometheus/dashboard.png" alt="JVM Micrometer 대시보드">    </p>
<p>이 대시보드는 현재 Spring boot에서 내보내는 metric을 Prometheus 서버가 scrape해서 데이터를 가져왔고, 저장된 데이터를 기준으로 Grafana에서 보여주고 있는 것이다.</p>
<p>사실 간단한 연동이라고 해서 진행을 했지만 도중에 어려운 부분이 하나씩 있을테니 가이드를 보면서 차근차근 도전해보는게 좋다. 사실 Prometheus로 시작했지만, 끝 마무리는 Grafana로 맺게 되는데.. Grafana를 약식으로 소개해서 그렇지 이 하나만 가지고도 여러개의 포스팅이 나올 수 있을만큼 강력하고 간단한 오픈소스 대시보드 솔루션이다.</p>
<p>이렇게 구성을 해두면 서비스를 하면서 문제가 생길만한 포인트를 사전에 알아본다던지, 현재 문제가 발생하는 부분이 어디에서 나는지(어떤 API가 현재 몇 TPS, Response time은 괜찮은지) 에 대한 정보를 얻을 수 있게 된다.</p>
<p>아무래도 devOps같은걸 하다보면 실제 개발만 하고 끝나는게 아니라 운영과 모니터링을 해야 하는데 그런 부분에서 Prometheus와 Grafana는 이런 정보를 얻기에 정말 간편한 구조를 채택하고 있음이 분명하고, 잘 활용을 한다면 높은 SLA 를 유지하는데 도움이 될 것이다.</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
  </section>

  


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" src="https://avatars1.githubusercontent.com/u/11327843?s=460&v=4" alt="곰팡이">
  <p class="site-author-name" itemprop="name">곰팡이</p>
  <div class="site-description motion-element" itemprop="description">개발덕후 삽질 끄적끄적..</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">3</span>
          <span class="site-state-item-name">포스트</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">카테고리</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">태그</span>
        </a>
      </div>
    
  </nav>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
      
        
      
        <a href="https://github.com/gompangs" title="GitHub &rarr; https://github.com/gompangs" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i></a>
      </span>
    
      <span class="links-of-author-item">
      
      
      
        
      
        <a href="mailto:stacks5978@gmail.com" title="E-Mail &rarr; mailto:stacks5978@gmail.com" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i></a>
      </span>
    
  </div>


  <div class="links-of-blogroll motion-element links-of-blogroll-inline">
    <div class="links-of-blogroll-title">
      <i class="fa  fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.linkedin.com/in/%EC%A7%84%EA%B7%A0-%EC%A0%95-bb12a610b/" title="https://www.linkedin.com/in/%EC%A7%84%EA%B7%A0-%EC%A0%95-bb12a610b/" rel="external nofollow noopener noreferrer" target="_blank">LinkedIn</a>
        </li>
      
    </ul>
  </div>

        </div>
      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">곰팡이</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> v3.9.0</div>

        








        
      </div>
    </footer>
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
      </div>

    

  </div>

  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

<script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>


  <script src="/js/affix.js?v=7.3.0"></script>
  <script src="/js/schemes/pisces.js?v=7.3.0"></script>



<script src="/js/next-boot.js?v=7.3.0"></script>






  




























  

  

  


  
    
<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://https-gompangs-github-io.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
